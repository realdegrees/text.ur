# AGENTS.md

## Project Overview

**text.ur** is a collaborative PDF annotation platform. FastAPI backend (Python 3.12+) with PostgreSQL/Redis/MinIO, SvelteKit frontend (Svelte 5 / TypeScript) with TailwindCSS 4 / Zod.

## Build / Lint / Test Commands

### Backend (`/backend`)

All backend commands assume the virtualenv is activated (`source .venv/bin/activate`) and are run from `/backend`.

| Task | Command |
|---|---|
| Lint | `ruff check .` |
| Lint fix | `ruff check --fix .` |
| Format | `ruff format .` |
| Format check | `ruff format --check .` |
| Run all tests | `pytest` |
| Run single test file | `pytest tests/app/test_document_access.py` |
| Run single test by name | `pytest -k "test_name_substring"` |
| Test with coverage | `pytest --cov=app --cov-report=html` |
| Create migration | `cd database && alembic revision --autogenerate -m "description"` |
| Apply migrations | `cd database && alembic upgrade head` |
| Run server | `uvicorn app.main:app --reload --port 8000` |

- Tests use a separate `test` database auto-created by `conftest.py`. Do not create it manually.
- `pytest.ini` sets `asyncio_mode = auto` — async test functions just work.
- Factory Boy factories live in `tests/factories/models.py`.

### Frontend (`/frontend`)

All frontend commands use `pnpm` and are run from `/frontend`.

| Task | Command |
|---|---|
| Install deps | `pnpm install` |
| Dev server | `pnpm dev` |
| Build | `pnpm build` |
| Type check | `pnpm check` |
| Lint (Prettier + ESLint) | `pnpm lint` |
| Lint fix | `pnpm lint:fix` |
| Run all tests | `pnpm test` |
| Run single test file | `pnpm exec vitest run src/demo.spec.ts` |
| Run tests matching name | `pnpm exec vitest run -t "test name"` |
| Test with coverage | `pnpm test:coverage` |
| Regenerate types from backend | `pnpm typegen` |

- After any backend model change, run `pnpm typegen` to regenerate `src/api/types.ts` and `src/api/schemas.ts`.
- Tests use `.spec.ts` extension and vitest (`describe`/`it`/`expect`).

## Code Style

### Backend (Python)

**Formatter/Linter:** Ruff (config in `pyproject.toml`).

- **Line length:** 80 characters.
- **Indent:** 4 spaces.
- **Quotes:** Double quotes (`"`).
- **Type annotations:** Required on all function parameters and return types. Use `|` union syntax (`str | None`, not `Optional[str]`).
- **Imports:** Standard library first, third-party second, local third (enforced by Ruff isort). Use named imports. Use `TYPE_CHECKING` guards for circular import situations.
- **Docstrings:** Required on all functions and classes except:
  - Model classes in `app/models/` (suppressed `D101`)
  - Route handler functions in `app/api/*/routers/` (suppressed `D103`)
  - Test functions (suppressed `D103`, `S101`)
- **Naming:**
  - `snake_case` for functions, variables, modules.
  - `PascalCase` for classes, type aliases.
  - `SCREAMING_SNAKE_CASE` for module-level constants.
- **Error handling:** Raise `AppException` (from `core/app_exception.py`) with `status_code`, `error_code` (from `AppErrorCode` enum), and `detail` string. Do not raise bare `HTTPException` in route handlers.
- **Models:** All DB models use SQLModel and inherit from `BaseModel` (`models/base.py`) which provides `created_at`/`updated_at`. Request/response schemas are separate Pydantic models (e.g., `DocumentCreate`, `DocumentRead`, `DocumentUpdate`).
- **Router:** Always use `util.api_router.APIRouter`, NOT `fastapi.APIRouter`. The custom router auto-registers trailing-slash variants.
- **Dependencies:** Use `Resource()` for single-item path parameter loading, `PaginatedResource()` for list endpoints with filtering/sorting. Auth via `Authenticate` dependency.

### Frontend (TypeScript / Svelte)

**Formatter:** Prettier (config in `.prettierrc`). **Linter:** ESLint (config in `eslint.config.js`).

- **Indentation:** Tabs (Prettier `useTabs: true`).
- **Quotes:** Single quotes (`'`).
- **Trailing commas:** None.
- **Print width:** 100 characters.
- **Semicolons:** Yes (Prettier default).
- **TypeScript:** Strict mode enabled. Use `type` imports for type-only usage (`import type { Foo } from ...`).
- **Imports:** Use path aliases: `$api/*`, `$lib/*`, `$i18n/*`, `$types/*`. Icons via `~icons/` prefix (unplugin-icons).
- **Naming:**
  - `camelCase` for variables, functions, and most component filenames.
  - `PascalCase` for types, interfaces, classes. Some component filenames use PascalCase.
- **Svelte 5 runes:** Use `$props()`, `$state()`, `$derived()`, `$effect()`. Reactive store files use `.svelte.ts` extension.
- **Error handling:** API calls return discriminated unions: `{ success: true; data: T } | { success: false; error: AppError }`. Always check `.success` before accessing `.data`.
- **Generated files (do not edit manually):**
  - `src/api/types.ts` — generated by `pydantic2ts`
  - `src/api/schemas.ts` — generated by `ts-to-zod`
  - `src/api/maps.generated.ts` — generated by `generate_exclusion_maps.py`
  - `src/i18n/` — managed by `typesafe-i18n`
- **ESLint rules:** `no-explicit-any` is off. `no-unused-vars` is a warning. `no-undef` is off (TypeScript handles this).

## Project Structure

```
backend/
  app/
    api/
      dependencies/    # Reusable FastAPI dependencies (auth, db, pagination, events, s3)
      routers/         # Route handlers per resource
    core/              # Config, auth (JWT), logging, exceptions
    models/            # SQLModel tables + Pydantic schemas
    util/              # Custom APIRouter, OpenAPI helpers, query utils
  database/            # Alembic migrations, init script, dumps
  tests/
    factories/         # factory_boy model factories
    app/               # Test files
frontend/
  src/
    api/               # Generated types, Zod schemas, API client
    lib/
      components/      # Reusable Svelte components
      runes/           # Svelte 5 reactive state (.svelte.ts)
      stores/          # Svelte stores (.svelte.ts)
      util/            # Helper functions
    routes/            # SvelteKit file-based routing
```

## CI Pipeline

The GitHub Actions workflow (`.github/workflows/ci.yml`) runs:

1. **Detect changes** — skips unaffected jobs via path filtering
2. **Lint backend** — `ruff check .`
3. **Lint frontend** — `pnpm lint`
4. **Validate migrations** — Alembic upgrade + drift check against Postgres 16
5. **Validate types** — `pnpm typegen` + check for uncommitted diffs
6. **Build frontend** — `pnpm build`
7. **Test backend** — `pytest --cov=app` (Postgres 16 + MinIO services)
8. **Test frontend** — `pnpm test:coverage`
9. **Dockerize** — build and push images to `ghcr.io`

## Key Conventions

- **Type sync pipeline:** Pydantic models -> `pydantic2ts` -> TypeScript types -> `ts-to-zod` -> Zod schemas. Always run `pnpm typegen` after backend model changes.
- **Access control:** Guard-based system with both SQL clauses and Python predicates. See `Guard.document_access()`, `Guard.comment_access()`.
- **WebSocket events:** Managed by `EventManager` (Redis pub/sub). Event routers use `get_events_router()` factory pattern.
- **Auth:** JWT tokens in secure HTTP-only cookies. `Authenticate` dependency for protected routes, `BasicAuthentication` for WebSocket (allows anonymous users).
- **Permissions:** Bitfield in `Membership.permissions`, defined in `models/enums.py`.
- **Field exclusion:** Filters can exclude redundant response fields via `FilterMeta.exclude`. See `docs/field-exclusion.md`.
